# Repository Technical Specs

These specifications describe technical aspects about this app. In particular, they discuss how the repository is organized, technical standards, etc.

## Technical overview

This app is built using a MERN stack: [Express.js](https://expressjs.com/) on [Node.js](https://nodejs.org), [MongoDB](https://www.mongodb.com/) (via [Mongoose](http://mongoosejs.com/)), and [React](https://facebook.github.io/react/).

We are running our apps on Google Cloud Platform, using Google App Engine. Builds and pull requests are tested and deployed via Travis.

## Some technical comments

+ This project is open to people from a variety of technical levels! So don't be afraid to try to contribute and, if you have questions, ask for help. (Also, React is not as complicated as it might seem at first!)

## Other technical information

+ [The structure of the database](DATABASE.md)
+ [The API backend](API.md)

### Notes for non-experts

+ .jsx are just javascript files which also allow React components (things that look like -- but are not quite -- standard html). If you know javascript, you should be able to understand them!

+ Javascript is fairly straightforward syntactically. However, one of the trickiest parts is that it is run typically asynchronously, which can be confusing. Understanding that makes a big difference in being able to read and write javascript effectively.

+ To learn React, if you know javascript, I suggest you go to the Facebook documents. Start with (the tutorial)[https://facebook.github.io/react/tutorial/tutorial.html] and then do (the Quickstart)[https://facebook.github.io/react/docs/installation.html]. These give a good overview of the framework.

## Repository organization

### Sources

The repository organization is as follows:

```
├──server/                      the Express backend for serving static 
│  │                            files andservicing the API
│  ├──routes/                   API routes
│  │  ├── index.js              main routes
│  │  ├── ...
│  ├──models/                   data models for API
│  │  ├── db.js                 connect to the mongo DB
│  │  ├── ...
│  ├──controllers/              backend API 
│  │  ├── ...
│  ├──_common/                  support files used in multiple sections
│  │  ├── ...
│  ├──server.js                 starting point for backend
│  ├──config-server.json        server config file; see below
├──src/                         client files for React
│  ├──App.jsx                   client starting point
│  ├──credentials-client.jsx    hold client credentials
│  ├── ...
├──static/                      static files
│  ├──index.html                shell for the client for React
│  ├── ...
├──scripts/                     scripts run separately from server process
│  ├── ...
```

### Production server

On the production server (or if `npm run compile`, `npm run compile-server` are run), the following additional files are generated by compiling the source:
```
├── dist/                 transpiled version of server/ from running babel
│   ├── ...
├── static/
│   ├── app.bundle.js     compiled client code from src
│   ├── vendor.bundle.js  compiled client code from node_modules
```

## Conventions

### REST API structure

+ For rest API endpoints, use spinal case, i.e. "this-style", not "thisStyle" or "this_style".

### Javascript syntax

+ Use ES2015 syntax on both the server and client-side (including modules). Babel will be used to transpile code for wider compatibility with older browsers

### React

+ React component class should be their own files

### JSON

We will (tentatively) follow the [Google JSON Style Guide](https://google.github.io/styleguide/jsoncstyleguide.xml).

### Linting

The code is linted via ESLint to follow the [Airbnb javascript guide](https://github.com/airbnb/javascript). For contributors: running eslint (after you have run `npm install` in the main directory to install dependencies) is as easy as running `npm run lint` in the main directory.

### Variable/property names

+ Variables/properties holding (the string form of) Mongo ObjectID's should end in "Id"; e.g. a variable holding the ObjectID for a User document could be called `userId`. Other variables should not end in "Id"; e.g., the variable that holds the Facebook ID of the user is called `userIdFb` not `userFbId` or `fBUserId`.

### State names

In the code, state names will be given as the 2-letter lowercase postal abbreviation

## Development

To develop the code base, do the following:

1. [Install mongodb](https://docs.mongodb.com/manual/administration/install-community/). 
1. Follow [these Github instructions](https://help.github.com/articles/fork-a-repo/) to fork this repo to your account
1. In the repo directory, install the dependencies by running
    $ npm install
1. [Set up configuration variables](#configuration-variables)
1. Copy server/credentials-template.js to server/credentials.js and edit it. For example, try changing `'mongodb://'` to `'mongodb://localhost/atibroadcastapp'`.
1. Make sure mongo is running.
1. Give your Google account the appropriate priveleges on the local install. To do this, first make sure that the file "scripts/addUser.js" is executable by running `chmod -x scripts/addUser.js`. Then, to add a user, run `scripts/addUser.js LOGINEMAIL FIRSTNAME LASTNAME` for each user.
1. Start the app via:

    $ npm run dev-all

The app should automatically detect changes to your code and recompile. The development server will listen on port 8000.

[Note that, to post message, you will first need to set a Facebook access token by running the "Update Access Token" option with the appoporiate Facebook user.]

### Configuration variables

The following configuration variables are recognized:

variable name | (R)equired or default value | description
---- | ---- | ----
port | 8080 | port on which server will be run
fb\_appsecretid | R | Facebook App secret
fb\_broadcastuserid | R | Facebook broadcast user ID
mongo_connectionstring | R | connection string for mongo
cookiesecret | R | salt for cookies
google_clientsecret | R | google client secret (currently not used)

*Note: config.js will automatically define the additional variable is_gae, which is true if the instance is run on GAE*

Note that all variables are lowercase and separate using underscores.

Because it is easiest to store configuration variables in different places in different environments, configuration variables are checked for in several places in the following order:
1. As argument (e.g. `node dist/server.js --port 40 --fb_appsecretid fjlj34`)
2. As an environmental variable
3. From the file server/config-server.json
4. From Google App Engine project metadata (if being run on Google App Engine)
